<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Panel Cripto â€” Simulador</title>

  <!-- Chart.js + plugin financial -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

  <!-- Luxon + adapter -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

  <style>
    body {margin:0;background:#0d1117;color:#e6edf3;font-family:Arial,Helvetica,sans-serif;}
    header {background:#161b22;padding:10px;font-weight:bold;}
    .container {display:grid;grid-template-columns:1.5fr .7fr;gap:15px;padding:15px;}
    .card {background:#161b22;border-radius:8px;padding:10px;}
    label{display:block;margin-top:8px;color:#8b949e;font-size:13px;}
    select,input,button{padding:6px;border-radius:4px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;}
    button{cursor:pointer;background:#238636;color:#fff;border:none;}
    button:hover{background:#2ea043;}
    #statusIndicator{position:fixed;bottom:10px;right:10px;padding:6px 12px;border-radius:8px;font-size:13px;}
    #statusIndicator.connecting{background:#d29922;color:#fff;}
    #statusIndicator.online{background:#238636;color:#fff;}
    #statusIndicator.offline{background:#f85149;color:#fff;}
    .calc-result{margin-top:8px;font-size:13px;}
    #log{height:120px;overflow-y:auto;background:#0d1117;padding:5px;border:1px solid #30363d;font-size:12px;}
  </style>
</head>
<body>
<header>Panel Cripto â€” Velas â€¢ Calculadora COP â€¢ Simulador de compras</header>

<div class="container">
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;">
      <label>Criptomoneda</label>
      <select id="symbolSelect"></select>
      <label>Intervalo</label>
      <select id="intervalSelect">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
      </select>
      <button id="connectBtn">Conectar</button>
      <div style="margin-left:auto;text-align:right;font-size:13px;">
        Estado: <span id="status">â€”</span><br>
        Precio: <span id="price">â€”</span>
      </div>
    </div>
    <canvas id="chart" height="300"></canvas>
  </div>

  <div class="card">
    <h3>Calculadora en COP</h3>
    <label>TRM (COP/USD)</label>
    <input id="trmInput" placeholder="Ej: 4000">
    <label>Monto a invertir (COP)</label>
    <input id="copAmount" placeholder="Ej: 1000000">
    <div class="calc-result" id="calcResult">Completa TRM y monto COP</div>

    <h3>SimulaciÃ³n de inversiÃ³n</h3>
    <button id="simulateBtn">ðŸ’° Simular compra</button>
    <div id="simList" class="calc-result">No hay simulaciones</div>

    <h3>Alertas manuales</h3>
    <button id="markBuy">ðŸ“¢ Marcar COMPRA</button>
    <button id="markSell">ðŸ“¢ Marcar VENTA</button>

    <h3>Registro</h3>
    <div id="log"></div>
  </div>
</div>

<div id="statusIndicator" class="offline">ðŸ”´ Desconectado</div>

<script defer>
const $=id=>document.getElementById(id);
let ws,lastPrice,chart,candles=[],closes=[],buySignals=[],sellSignals=[];
let simulaciones = JSON.parse(localStorage.getItem("simulaciones") || "[]");

const SYMBOLS=["BTCUSDT","ETHUSDT","BNBUSDT","XRPUSDT","LTCUSDT"];

function log(msg){
  const time=new Date().toLocaleTimeString();
  $("log").innerHTML+=`[${time}] ${msg}<br>`;
  $("log").scrollTop=$("log").scrollHeight;
}
function setStatus(st){
  if(st==="online"){
    $("statusIndicator").className="online";
    $("statusIndicator").textContent="ðŸŸ¢ Conectado";
    $("status").textContent="Conectado";
  }else if(st==="connecting"){
    $("statusIndicator").className="connecting";
    $("statusIndicator").textContent="ðŸŸ¡ Conectando...";
    $("status").textContent="Conectando";
  }else{
    $("statusIndicator").className="offline";
    $("statusIndicator").textContent="ðŸ”´ Desconectado";
    $("status").textContent="Desconectado";
    $("price").textContent="â€”";
  }
}

// Inicializar lista de sÃ­mbolos
SYMBOLS.forEach(s=>{
  const o=document.createElement("option");
  o.value=s;o.textContent=s;
  $("symbolSelect").appendChild(o);
});
$("symbolSelect").value="BTCUSDT";

// Crear grÃ¡fico
function initChart(){
  if(chart) chart.destroy();
  const ctx=$("chart").getContext("2d");
  chart=new Chart(ctx,{
    type:"candlestick",
    data:{datasets:[
      {label:"Candlestick",data:candles},
      {label:"Compra",data:buySignals,type:"scatter",showLine:false,pointStyle:"triangle",rotation:0,pointRadius:10,borderColor:"green",backgroundColor:"green"},
      {label:"Venta",data:sellSignals,type:"scatter",showLine:false,pointStyle:"triangle",rotation:180,pointRadius:10,borderColor:"red",backgroundColor:"red"}
    ]},
    options:{
      plugins:{legend:{labels:{color:"#e6edf3"}}},
      scales:{x:{type:"time",ticks:{color:"#aaa"}},y:{ticks:{color:"#aaa"}}}
    }
  });
}

function updateChart(){
  chart.data.datasets[0].data=candles;
  chart.update();
}

function openWS(sym,intv){
  if(ws){ws.close();ws=null;}
  setStatus("connecting");
  ws=new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_${intv}`);
  ws.onopen=()=>{setStatus("online");log("WS conectado");};
  ws.onmessage=e=>{
    const d=JSON.parse(e.data);
    if(!d.k) return;
    lastPrice=+d.k.c;
    $("price").textContent=lastPrice.toFixed(2);
    const c={x:new Date(d.k.t),o:+d.k.o,h:+d.k.h,l:+d.k.l,c:+d.k.c};
    const i=candles.findIndex(cc=>cc.x.getTime()===c.x.getTime());
    if(i>=0) candles[i]=c; else candles.push(c);
    closes.push(c.c);
    if(closes.length>100) closes.shift();
    updateChart();
  };
  ws.onclose=()=>{setStatus("offline");log("WS cerrado, reconectando...");setTimeout(()=>openWS(sym,intv),5000);};
}

$("connectBtn").onclick=()=>{
  candles=[];closes=[];buySignals=[];sellSignals=[];
  initChart();updateChart();
  openWS($("symbolSelect").value,$("intervalSelect").value);
};

// Calculadora
function updateCalc(){
  const trm=parseFloat($("trmInput").value);
  const cop=parseFloat($("copAmount").value);
  if(!trm||!cop||!lastPrice){
    $("calcResult").textContent="Completa TRM y monto COP";
    return;
  }
  const entry=lastPrice;
  const qty=cop/(entry*trm);
  const cur=lastPrice;
  const res=((cur-entry)/entry*100).toFixed(2);
  const pl=((cur-entry)*qty*trm).toFixed(0);
  $("calcResult").innerHTML=`
    InversiÃ³n: ${cop.toLocaleString()} COP<br>
    Cripto: ${qty.toFixed(8)} ${$("symbolSelect").value.replace("USDT","")}<br>
    Entrada: ${entry.toFixed(2)} USDT<br>
    Actual: ${cur.toFixed(2)} USDT<br>
    Resultado: ${res}% â†’ ${parseInt(pl).toLocaleString()} COP
  `;
}
setInterval(updateCalc,1000);

// Simulaciones
function guardarSimulacion(){
  const cop=parseFloat($("copAmount").value);
  const trm=parseFloat($("trmInput").value);
  if(!cop||!trm||!lastPrice){
    alert("Completa TRM, monto COP y conecta primero.");
    return;
  }
  const entry=lastPrice;
  const qty=cop/(entry*trm);
  const sim={id:Date.now(),cop,trm,entry,qty,symbol:$("symbolSelect").value};
  simulaciones.unshift(sim);
  if(simulaciones.length>10) simulaciones.pop();
  localStorage.setItem("simulaciones",JSON.stringify(simulaciones));
  renderSimulaciones();
}

function renderSimulaciones(){
  if(!simulaciones.length){
    $("simList").innerText="No hay simulaciones";return;
  }
  $("simList").innerHTML=simulaciones.map(sim=>{
    const cur=lastPrice||sim.entry;
    const pl=((cur-sim.entry)/sim.entry*100).toFixed(2);
    const plCop=((cur-sim.entry)*sim.qty*sim.trm).toFixed(0);
    return `
      <div style="margin-bottom:6px;border-bottom:1px solid #30363d;padding-bottom:4px">
        <b>${sim.symbol}</b><br>
        Entrada: ${sim.entry.toFixed(2)} USDT<br>
        InversiÃ³n: ${sim.cop.toLocaleString()} COP<br>
        Actual: ${cur.toFixed(2)} USDT<br>
        Resultado: ${pl}% â†’ ${parseInt(plCop).toLocaleString()} COP
      </div>
    `;
  }).join("");
}
$("simulateBtn").onclick=guardarSimulacion;
setInterval(renderSimulaciones,1000);
renderSimulaciones();

// Alertas manuales
$("markBuy").onclick=()=>{buySignals.push({x:new Date(),y:lastPrice});updateChart();};
$("markSell").onclick=()=>{sellSignals.push({x:new Date(),y:lastPrice});updateChart();};

// Inicializar grÃ¡fico vacÃ­o
initChart();
</script>
</body>
</html>
