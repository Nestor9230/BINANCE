<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Cripto - Velas con Proxy Binance</title>

  <!-- Chart.js + plugin financial -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>

  <!-- Luxon + Adapter fechas -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0d1117;color:#e6edf3}
    header{background:#161b22;padding:14px 20px;font-weight:bold}
    .container{max-width:1200px;margin:20px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .card{background:#161b22;border-radius:10px;padding:14px;box-shadow:0 4px 18px rgba(0,0,0,.35)}
    label{font-size:13px;color:#8b949e}
    select,input,button{padding:8px 10px;border-radius:6px;border:1px solid #30363d;background:#0d1117;color:#e6edf3}
    button{cursor:pointer;background:#238636;border:none;color:white;font-weight:bold}
    button:hover{background:#2ea043}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .log{max-height:180px;overflow:auto;font-family:monospace;font-size:12px;background:#0d1117;padding:8px;border-radius:6px;white-space:pre-wrap}
    canvas{height:420px !important}
    .calc-result{background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:8px;margin-top:8px;white-space:pre-line}
    .signalBox{margin-top:10px;padding:10px;border-radius:8px;font-weight:bold}
    .buy{background:rgba(46,160,67,0.2);color:#2ea043}
    .sell{background:rgba(219,48,48,0.2);color:#ff5c5c}
    #statusIndicator{
      position:fixed;bottom:10px;right:15px;padding:6px 12px;border-radius:6px;
      font-size:13px;font-weight:bold;color:white;z-index:9999;
    }
    .online{background:#2ea043;}
    .connecting{background:#d4a017;}
    .offline{background:#d73a49;}
    .muted{color:#9aa4bf;font-size:13px}
    #errorBox{margin-top:10px;padding:8px;border:1px solid #ff5c5c;border-radius:6px;
      color:#ff5c5c;font-size:13px;max-height:100px;overflow:auto;white-space:pre-line;}
  </style>
</head>
<body>
  <header>Panel Cripto â€” Velas â€¢ Calculadora COP â€¢ SeÃ±ales + Alertas manuales</header>

  <div class="container">
    <div class="grid">
      <!-- GrÃ¡fica -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div style="display:flex;gap:10px;align-items:flex-end">
            <div>
              <label>Criptomoneda</label><br>
              <select id="symbolSelect"></select>
            </div>
            <div>
              <label>Intervalo</label><br>
              <select id="interval">
                <option value="1m">1m</option>
                <option value="5m" selected>5m</option>
                <option value="15m">15m</option>
                <option value="1h">1h</option>
              </select>
            </div>
            <div><button id="connectBtn">Conectar</button></div>
          </div>

          <div style="text-align:right">
            <div class="muted" id="statusText">Estado: â€”</div>
            <div class="muted" id="lastPriceMini">Precio: â€”</div>
          </div>
        </div>

        <canvas id="chart"></canvas>
        <div id="signalBox" class="signalBox muted">â€”</div>
        <div id="errorBox">Sin errores</div>
      </div>

      <!-- Panel lateral -->
      <div class="card">
        <h3>Calculadora en COP</h3>
        <label>TRM (COP/USD)</label><br>
        <input id="trmInput" type="number" placeholder="Ej: 4000" /><br>
        <label>Monto a invertir (COP)</label><br>
        <input id="copAmount" type="number" placeholder="Ej: 1000000" /><br>
        <label>Precio de entrada (USDT, opcional)</label><br>
        <input id="entryPrice" type="number" placeholder="Si vacÃ­o = entrada ahora" /><br>
        <div id="calcResult" class="calc-result">Resultado: â€”</div>

        <h3>Alertas manuales</h3>
        <button id="manualBuyBtn">ðŸ“¢ Marcar COMPRA</button>
        <button id="manualSellBtn">ðŸš¨ Marcar VENTA</button>

        <h4>Registro</h4>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <div id="statusIndicator" class="offline">ðŸ”´ Desconectado</div>

  <script defer>
    const $=id=>document.getElementById(id);
    const SYMBOLS=['BTCUSDT','ETHUSDT','BNBUSDT','XRPUSDT','ADAUSDT','SOLUSDT','DOGEUSDT','DOTUSDT','MATICUSDT','LTCUSDT'];
    let candles=[],closes=[],chart,ws;
    let buySignals=[],sellSignals=[];
    let lastKlineStart=null;

    function log(m){const t=new Date().toLocaleTimeString();$('log').innerText=`[${t}] ${m}\n`+$('log').innerText;}
    function showError(msg){
      const t=new Date().toLocaleTimeString();
      const box=$('errorBox');
      if(box.innerText==="Sin errores") box.innerText="";
      box.innerText=`[${t}] ${msg}\n`+box.innerText;
    }

    function setStatus(state,text){
      const el=$('statusIndicator');
      if(state==='online'){el.className='online';el.textContent='ðŸŸ¢ Conectado';$('statusText').textContent='Estado: Conectado';}
      else if(state==='connecting'){el.className='connecting';el.textContent='ðŸŸ¡ Conectando...';$('statusText').textContent='Estado: Conectando';}
      else{el.className='offline';el.textContent='ðŸ”´ Desconectado';$('statusText').textContent='Estado: Desconectado';}
      if(text)$('lastPriceMini').textContent='Precio: '+text;
    }

    // ðŸš€ Ahora con proxy CORS
    async function fetchKlines(sym,intv){
      const endpoints = [
        "https://api.binance.com",
        "https://api1.binance.com",
        "https://api2.binance.com",
        "https://api3.binance.com",
        "https://api.binance.us"
      ];
      for(let base of endpoints){
        try{
          const target = `${base}/api/v3/klines?symbol=${sym}&interval=${intv}&limit=200`;
          const url = `https://corsproxy.io/?${encodeURIComponent(target)}`;
          const resp=await fetch(url);
          if(resp.ok){
            log("HistÃ³rico desde: "+base+" (via proxy)");
            return await resp.json();
          }
        }catch(e){
          showError("FallÃ³ "+base+" â†’ "+e.message);
        }
      }
      throw new Error("No se pudo obtener histÃ³rico desde ningÃºn endpoint");
    }

    function initChart(){
      if (chart) { chart.destroy(); }
      const ctx=$('chart').getContext('2d');
      chart=new Chart(ctx,{
        type:'candlestick',
        data:{datasets:[
          {label:'Candlestick',data:candles},
          {label:'Compra',data:buySignals,type:'scatter',showLine:false,pointStyle:'triangle',rotation:0,pointRadius:10,borderColor:'green',backgroundColor:'green'},
          {label:'Venta',data:sellSignals,type:'scatter',showLine:false,pointStyle:'triangle',rotation:180,pointRadius:10,borderColor:'red',backgroundColor:'red'}
        ]},
        options:{
          plugins:{legend:{labels:{color:'#e6edf3'}}},
          scales:{
            x:{type:'time',ticks:{color:'#aaa'}},
            y:{ticks:{color:'#aaa'}}
          }
        }
      });
    }
    function updateChart(){chart.data.datasets[0].data=candles;chart.data.datasets[1].data=buySignals;chart.data.datasets[2].data=sellSignals;chart.update('none');}

    async function start(sym,intv){
      if(ws){try{ws.close();}catch{} ws=null;}
      setStatus('connecting');
      try{
        const data=await fetchKlines(sym,intv);
        candles=data.map(k=>({x:new Date(k[0]),o:+k[1],h:+k[2],l:+k[3],c:+k[4]}));
        closes=data.map(k=>+k[4]);
        buySignals=[];sellSignals=[];
        initChart();updateChart();
        openWS(sym,intv);
      }catch(err){
        log("Error histÃ³rico: "+err.message);
        showError("Error histÃ³rico: "+err.message);
        setStatus('offline');
      }
    }
    function openWS(sym,intv){
      ws=new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_${intv}`);
      ws.onopen=()=>{log('WS conectado');setStatus('online',closes.at(-1));};
      ws.onclose=()=>{log('WS cerrado, reconectando...');showError("WS cerrado, reconectando...");setStatus('offline');setTimeout(()=>start(sym,intv),4000);};
      ws.onerror=e=>{showError("Error WS: "+e.message);};
      ws.onmessage=e=>{const k=JSON.parse(e.data).k;if(!k)return;handleKline(k);};
    }
    function handleKline(k){
      const c={x:new Date(k.t),o:+k.o,h:+k.h,l:+k.l,c:+k.c};
      if(lastKlineStart===null||k.t!==lastKlineStart){lastKlineStart=k.t;candles.push(c);closes.push(c.c);}else{candles[candles.length-1]=c;closes[closes.length-1]=c.c;}
      if(candles.length>200){candles.shift();closes.shift();}
      updateChart();setStatus('online',closes.at(-1));updateCalc();
    }

    function updateCalc(){
      const cop=parseFloat($('copAmount').value),trm=parseFloat($('trmInput').value);
      if(!cop||!trm||!closes.length){
        $('calcResult').innerText='Completa TRM y monto COP';
        return;
      }
      const cur=closes.at(-1),entry=parseFloat($('entryPrice').value)||cur;
      const qty=cop/(cur*trm),pl=((cur-entry)/entry*100),plCop=(cur-entry)*qty*trm;
      $('calcResult').innerText=
        `InversiÃ³n: ${cop.toLocaleString()} COP\n`+
        `Cripto: ${qty.toFixed(8)} ${$('symbolSelect').value.replace('USDT','')}\n`+
        `Entrada: ${entry} USDT\nActual: ${cur} USDT\n`+
        `Resultado: ${pl.toFixed(2)}% â†’ ${plCop.toLocaleString()} COP`;
    }

    $('connectBtn').onclick=()=>start($('symbolSelect').value,$('interval').value);
    $('trmInput').oninput=()=>{localStorage.setItem('trmValue',$('trmInput').value);updateCalc();};
    $('copAmount').oninput=updateCalc;$('entryPrice').oninput=updateCalc;
    $('manualBuyBtn').onclick=()=>{buySignals.push({x:candles.at(-1).x,y:candles.at(-1).c});log('ðŸ“¢ Alerta MANUAL COMPRA');updateChart();};
    $('manualSellBtn').onclick=()=>{sellSignals.push({x:candles.at(-1).x,y:candles.at(-1).c});log('ðŸš¨ Alerta MANUAL VENTA');updateChart();};

    // Inicializar lista
    SYMBOLS.forEach(s=>{
      const o=document.createElement('option');
      o.value=s; o.textContent=s;
      $('symbolSelect').appendChild(o);
    });
    $('symbolSelect').value='BTCUSDT';
    if(localStorage.getItem('trmValue'))
      $('trmInput').value=localStorage.getItem('trmValue');
  </script>
</body>
</html>
