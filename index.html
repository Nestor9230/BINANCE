<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Panel Cripto ‚Äî Simulador</title>

  <!-- Chart.js + plugin financial -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

  <!-- Luxon + adapter -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

  <style>
    body {margin:0;background:#0d1117;color:#e6edf3;font-family:Arial,Helvetica,sans-serif;}
    header {background:#161b22;padding:10px;font-weight:bold;}
    .container {display:grid;grid-template-columns:1.5fr .7fr;gap:15px;padding:15px;}
    .card {background:#161b22;border-radius:8px;padding:10px;}
    label{display:block;margin-top:8px;color:#8b949e;font-size:13px;}
    select,input,button{padding:6px;border-radius:4px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;}
    button{cursor:pointer;background:#238636;color:#fff;border:none;}
    button:hover{background:#2ea043;}
    #statusIndicator{position:fixed;bottom:10px;right:10px;padding:6px 12px;border-radius:8px;font-size:13px;}
    #statusIndicator.connecting{background:#d29922;color:#fff;}
    #statusIndicator.online{background:#238636;color:#fff;}
    #statusIndicator.offline{background:#f85149;color:#fff;}
    .calc-result{margin-top:8px;font-size:13px;}
    #log{height:120px;overflow-y:auto;background:#0d1117;padding:5px;border:1px solid #30363d;font-size:12px;}
    .sim-box{margin-bottom:6px;border-bottom:1px solid #30363d;padding-bottom:4px;}
    .sim-delete{background:#f85149;color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:11px;float:right;}
  </style>
</head>
<body>
<header>Panel Cripto ‚Äî Velas ‚Ä¢ Calculadora COP ‚Ä¢ Simulador de compras</header>

<div class="container">
  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;">
      <label>Criptomoneda</label>
      <select id="symbolSelect"></select>
      <label>Intervalo</label>
      <select id="intervalSelect">
        <option value="1">1s</option>
        <option value="2">2s</option>
        <option value="5">5s</option>
        <option value="10">10s</option>
      </select>
      <button id="connectBtn">Conectar</button>
      <div style="margin-left:auto;text-align:right;font-size:13px;">
        Estado: <span id="status">‚Äî</span><br>
        Precio: <span id="price">‚Äî</span>
      </div>
    </div>
    <canvas id="chart" height="300"></canvas>
  </div>

  <div class="card">
    <h3>Calculadora en COP</h3>
    <label>TRM (COP/USD)</label>
    <input id="trmInput" placeholder="Ej: 4000">
    <label>Monto a invertir (COP)</label>
    <input id="copAmount" placeholder="Ej: 1000000">
    <div class="calc-result" id="calcResult">Completa TRM y monto COP</div>

    <h3>Simulaci√≥n de inversi√≥n</h3>
    <button id="simulateBtn">üí∞ Simular compra</button>
    <button id="downloadBtn">‚¨áÔ∏è Descargar CSV</button>
    <div id="simList" class="calc-result">No hay simulaciones</div>

    <h3>Registro</h3>
    <div id="log"></div>
  </div>
</div>

<div id="statusIndicator" class="offline">üî¥ Desconectado</div>

<script defer>
const $=id=>document.getElementById(id);
let ws,lastPrice,chart,candles=[],closes=[];
let simulaciones = JSON.parse(localStorage.getItem("simulaciones") || "[]");

// Colores para l√≠neas de simulaciones
const COLORS=["#ff6384","#36a2eb","#cc65fe","#ffce56","#4bc0c0","#9966ff","#ff9f40","#8bc34a","#e91e63","#00bcd4"];

const SYMBOLS=["BTCUSDT","ETHUSDT","BNBUSDT","XRPUSDT","LTCUSDT"];
SYMBOLS.forEach(s=>{
  const o=document.createElement("option");
  o.value=s;o.textContent=s;
  $("symbolSelect").appendChild(o);
});
$("symbolSelect").value="BTCUSDT";

function log(msg){
  const time=new Date().toLocaleTimeString();
  $("log").innerHTML+=`[${time}] ${msg}<br>`;
  $("log").scrollTop=$("log").scrollHeight;
}
function setStatus(st){
  if(st==="online"){
    $("statusIndicator").className="online";
    $("statusIndicator").textContent="üü¢ Conectado";
    $("status").textContent="Conectado";
  }else if(st==="connecting"){
    $("statusIndicator").className="connecting";
    $("statusIndicator").textContent="üü° Conectando...";
    $("status").textContent="Conectando";
  }else{
    $("statusIndicator").className="offline";
    $("statusIndicator").textContent="üî¥ Desconectado";
    $("status").textContent="Desconectado";
    $("price").textContent="‚Äî";
  }
}

function initChart(){
  if(chart) chart.destroy();
  const ctx=$("chart").getContext("2d");
  chart=new Chart(ctx,{
    type:"candlestick",
    data:{datasets:[{label:"Candlestick",data:candles}]},
    options:{
      plugins:{legend:{labels:{color:"#e6edf3"}}},
      scales:{x:{type:"time",ticks:{color:"#aaa"}},y:{ticks:{color:"#aaa"}}}
    }
  });
}
function updateChart(){
  chart.data.datasets[0].data=candles;
  chart.data.datasets = chart.data.datasets.slice(0,1);
  simulaciones.forEach((sim,i)=>{
    chart.data.datasets.push({
      label:`Sim ${i+1} (${sim.entry.toFixed(2)})`,
      data:[{x:candles.length?candles[0].x:new Date(),y:sim.entry},
            {x:new Date(),y:sim.entry}],
      type:"line",
      borderColor:COLORS[i%COLORS.length],
      borderWidth:1,
      borderDash:[4,4],
      pointRadius:0
    });
  });
  chart.update();
}

// Construcci√≥n de velas en segundos
let aggInterval=1;
let aggCandle=null;
function handleTrade(price){
  const now=Math.floor(Date.now()/1000);
  if(!aggCandle){
    aggCandle={time:now,open:price,high:price,low:price,close:price};
    return;
  }
  if(now-aggCandle.time<aggInterval){
    aggCandle.high=Math.max(aggCandle.high,price);
    aggCandle.low=Math.min(aggCandle.low,price);
    aggCandle.close=price;
  }else{
    candles.push({x:new Date(aggCandle.time*1000),o:aggCandle.open,h:aggCandle.high,l:aggCandle.low,c:aggCandle.close});
    if(candles.length>200) candles.shift();
    closes.push(aggCandle.close);
    if(closes.length>200) closes.shift();
    aggCandle={time:now,open:price,high:price,low:price,close:price};
    updateChart();
  }
}

function openWS(sym,intv){
  if(ws){ws.close();ws=null;}
  setStatus("connecting");
  aggInterval=parseInt(intv);
  candles=[];closes=[];aggCandle=null;
  initChart();updateChart();
  ws=new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@ticker`);
  ws.onopen=()=>{setStatus("online");log("WS conectado");};
  ws.onmessage=e=>{
    const d=JSON.parse(e.data);
    lastPrice=+d.c;
    $("price").textContent=lastPrice.toFixed(2);
    handleTrade(lastPrice);
  };
  ws.onclose=()=>{
    setStatus("offline");
    log("WS cerrado, reconectando en 10s...");
    setTimeout(()=>openWS(sym,intv),10000);
  };
}
$("connectBtn").onclick=()=>openWS($("symbolSelect").value,$("intervalSelect").value);

// Calculadora
function updateCalc(){
  const trm=parseFloat($("trmInput").value);
  const cop=parseFloat($("copAmount").value);
  if(!trm||!cop||!lastPrice){$("calcResult").textContent="Completa TRM y monto COP";return;}
  const entry=lastPrice;
  const qty=cop/(entry*trm);
  const cur=lastPrice;
  const res=((cur-entry)/entry*100).toFixed(2);
  const pl=((cur-entry)*qty*trm).toFixed(0);
  $("calcResult").innerHTML=`
    Inversi√≥n: ${cop.toLocaleString()} COP<br>
    Cripto: ${qty.toFixed(8)} ${$("symbolSelect").value.replace("USDT","")}<br>
    Entrada: ${entry.toFixed(2)} USDT<br>
    Actual: ${cur.toFixed(2)} USDT<br>
    Resultado: ${res}% ‚Üí ${parseInt(pl).toLocaleString()} COP
  `;
}
setInterval(updateCalc,1000);

// Simulaciones
function guardarSimulacion(){
  const cop=parseFloat($("copAmount").value);
  const trm=parseFloat($("trmInput").value);
  if(!cop||!trm||!lastPrice){alert("Completa TRM, monto COP y conecta primero.");return;}
  const entry=lastPrice;
  const qty=cop/(entry*trm);
  const sim={id:Date.now(),cop,trm,entry,qty,symbol:$("symbolSelect").value};
  simulaciones.unshift(sim);
  if(simulaciones.length>10) simulaciones.pop();
  localStorage.setItem("simulaciones",JSON.stringify(simulaciones));
  renderSimulaciones();
  updateChart();
}
function eliminarSimulacion(id){
  simulaciones=simulaciones.filter(s=>s.id!==id);
  localStorage.setItem("simulaciones",JSON.stringify(simulaciones));
  renderSimulaciones();
  updateChart();
}
function renderSimulaciones(){
  if(!simulaciones.length){$("simList").innerText="No hay simulaciones";return;}
  $("simList").innerHTML=simulaciones.map((sim,i)=>{
    const cur=lastPrice||sim.entry;
    const pl=((cur-sim.entry)/sim.entry*100).toFixed(2);
    const plCop=((cur-sim.entry)*sim.qty*sim.trm).toFixed(0);
    return `<div class="sim-box">
      <button class="sim-delete" onclick="eliminarSimulacion(${sim.id})">‚ùå</button>
      <b>${sim.symbol}</b><br>
      Entrada: ${sim.entry.toFixed(2)} USDT<br>
      Inversi√≥n: ${sim.cop.toLocaleString()} COP<br>
      Actual: ${cur.toFixed(2)} USDT<br>
      Resultado: ${pl}% ‚Üí ${parseInt(plCop).toLocaleString()} COP
    </div>`;
  }).join("");
}
$("simulateBtn").onclick=guardarSimulacion;
setInterval(renderSimulaciones,1000);
renderSimulaciones();

// Exportar CSV
$("downloadBtn").onclick=()=>{
  if(!simulaciones.length){alert("No hay simulaciones guardadas.");return;}
  let csv="S√≠mbolo,Entrada USDT,Monto COP,TRM,Cantidad,P&L %,P&L COP\n";
  simulaciones.forEach(sim=>{
    const cur=lastPrice||sim.entry;
    const pl=((cur-sim.entry)/sim.entry*100).toFixed(2);
    const plCop=((cur-sim.entry)*sim.qty*sim.trm).toFixed(0);
    csv+=`${sim.symbol},${sim.entry},${sim.cop},${sim.trm},${sim.qty},${pl},${plCop}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="simulaciones.csv";a.click();
  URL.revokeObjectURL(url);
};

// Inicializar
initChart();
</script>
</body>
</html>
